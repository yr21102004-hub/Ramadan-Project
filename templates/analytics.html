{% extends "layout.html" %}

{% block content %}
<style>
    .kpi-info p,
    .nav-card p,
    .text-muted,
    .section-padding p {
        color: #e0e0e0 !important;
    }

    .chart-card h5 {
        color: #fff !important;
    }
</style>
<section class="section-padding admin-section-bg">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-light btn-sm mb-3">
                    <i class="fas fa-arrow-right me-2"></i> العودة للوحة التحكم
                </a>
                <h2 class="section-title mb-0">إحصائيات الموقع (Analytics)</h2>
                <p class="text-muted mt-2">تحليل شامل لأداء الموقع وتفاعل المستخدمين</p>
            </div>
        </div>

        <div class="divider mb-5"></div>

        <!-- Analytics Dashboard -->
        <div class="analytics-section mb-5" data-aos="fade-up">

            <!-- KPI Cards -->
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-icon bg-primary-soft"><i class="fas fa-users text-primary"></i></div>
                    <div class="kpi-info">
                        <h4>{{ analytics.total_users }}</h4>
                        <p>إجمالي المستخدمين المسجلين</p>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon bg-warning-soft"><i class="fas fa-clipboard-list text-warning"></i></div>
                    <div class="kpi-info">
                        <h4>{{ analytics.total_requests }}</h4>
                        <p>إجمالي طلبات المعاينة</p>
                    </div>
                </div>
                <div class="kpi-card">
                    {% set rate = analytics.conversion_rate %}
                    {% set rate_color = 'text-success' if rate >= 50 else 'text-info' if rate >= 20 else 'text-danger'
                    %}
                    {% set bg_color = 'bg-success-soft' if rate >= 50 else 'bg-info-soft' if rate >= 20 else
                    'bg-danger-soft' %}
                    <div class="kpi-icon {{ bg_color }}"><i class="fas fa-percentage {{ rate_color }}"></i></div>
                    <div class="kpi-info">
                        <h4 class="{{ rate_color }}">{{ rate }}%</h4>
                        <p>نسبة الطلب للعملاء</p>
                    </div>
                </div>
                <!-- Top Visitor KPI -->
                <div class="kpi-card">
                    <div class="kpi-icon bg-success-soft"><i class="fas fa-crown text-success"></i></div>
                    <div class="kpi-info">
                        <h4>{{ analytics.top_all_visitors_labels[0] if analytics.top_all_visitors_labels else '-' }}
                        </h4>
                        <p>الأكثر زيارة (تسجيل دخول)</p>
                    </div>
                </div>
            </div>

            <!-- Charts Grid 0 (Detailed Activity) -->
            <div class="charts-grid mt-4">
                <div class="chart-card">
                    <h5><i class="fas fa-comments text-gold me-2"></i> المستخدمين النشطين على AI (يومين فأكثر)</h5>
                    <div class="chart-wrapper">
                        <canvas id="aiChart"></canvas>
                        {% if not analytics.top_ai_labels %}
                        <div class="text-center text-muted"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            لا توجد بيانات
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="chart-card">
                    <h5><i class="fas fa-history text-gold me-2"></i> جميع المستخدمين النشطين (إجمالي الزيارات)</h5>
                    <div class="chart-wrapper">
                        <canvas id="allTimeVisitorsChart"></canvas>
                        {% if not analytics.top_all_visitors_labels %}
                        <div class="text-center text-muted"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            لا توجد بيانات
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Charts Grid 1 (Visitors Today) -->
            <div class="charts-grid mt-4">
                <div class="chart-card">
                    <h5><i class="fas fa-users text-gold me-2"></i> مستخدمين زاروا الموقع أكثر من مرتين اليوم</h5>
                    <div class="chart-wrapper">
                        <canvas id="chatChart"></canvas>
                        {% if not analytics.heavy_visitors_labels %}
                        <div class="text-center text-muted"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            لا توجد بيانات
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="chart-card">
                    <h5><i class="fas fa-user-check text-gold me-2"></i> مستخدمين زاروا الموقع مرة واحدة اليوم</h5>
                    <div class="chart-wrapper">
                        <canvas id="loginChart"></canvas>
                        {% if not analytics.daily_visitors_labels %}
                        <div class="text-center text-muted"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            لا توجد بيانات
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Charts Grid 2 (Services) -->
            <div class="charts-grid mt-4">
                <div class="chart-card">
                    <h5><i class="fas fa-clipboard-list text-gold me-2"></i> أكثر الخدمات طلباً (من الرسائل)</h5>
                    <div class="chart-wrapper">
                        <canvas id="servicesReqChart"></canvas>
                        {% if not analytics.top_services_req_labels %}
                        <div class="text-center text-muted"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            لا توجد بيانات
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="chart-card">
                    <h5><i class="fas fa-eye text-gold me-2"></i> أكثر الخدمات مشاهدة (زيارات الصفحات)</h5>
                    <div class="chart-wrapper">
                        <canvas id="servicesViewChart"></canvas>
                        {% if not analytics.top_services_view_labels %}
                        <div class="text-center text-muted"
                            style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            لا توجد بيانات
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Divider for Advanced -->
            <div class="divider my-5"></div>
            <h3 class="text-gold mb-4"><i class="fas fa-magic me-2"></i> تحليلات متقدمة (Advanced Insights)</h3>

            <!-- Row 3: Peak Hours (Full Width) -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="chart-card">
                        <h5><i class="fas fa-clock text-gold me-2"></i> توزيع النشاط على مدار اليوم ( Peak Hours )</h5>
                        <div class="chart-wrapper" style="height: 300px;">
                            <canvas id="peakHoursChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 4: AI Efficiency & Page Popularity -->
            <div class="charts-grid mt-4">
                <div class="chart-card">
                    <h5><i class="fas fa-robot text-gold me-2"></i> كفاءة الرد الآلي (AI Efficiency)</h5>
                    <div class="chart-wrapper">
                        <canvas id="aiEfficiencyChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h5><i class="fas fa-map-marked-alt text-gold me-2"></i> الصفحات الأكثر زيارة (General Popularity)
                    </h5>
                    <div class="chart-wrapper">
                        <canvas id="pagePopChart"></canvas>
                    </div>
                </div>
            </div>

        </div>

    </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Prepare Data (Safe Parsing to avoid IDE errors)
        const chartData = {
            topAiLabels: JSON.parse('{{ analytics.top_ai_labels | tojson | safe }}'),
            topAiValues: JSON.parse('{{ analytics.top_ai_values | tojson | safe }}'),

            allTimeLabels: JSON.parse('{{ analytics.top_all_visitors_labels | tojson | safe }}'),
            allTimeValues: JSON.parse('{{ analytics.top_all_visitors_values | tojson | safe }}'),

            chatLabels: JSON.parse('{{ analytics.heavy_visitors_labels | tojson | safe }}'),
            chatValues: JSON.parse('{{ analytics.heavy_visitors_values | tojson | safe }}'),

            loginLabels: JSON.parse('{{ analytics.daily_visitors_labels | tojson | safe }}'),
            loginValues: JSON.parse('{{ analytics.daily_visitors_values | tojson | safe }}'),

            reqLabels: JSON.parse('{{ analytics.top_services_req_labels | tojson | safe }}'),
            reqValues: JSON.parse('{{ analytics.top_services_req_values | tojson | safe }}'),

            viewLabels: JSON.parse('{{ analytics.top_services_view_labels | tojson | safe }}'),
            viewValues: JSON.parse('{{ analytics.top_services_view_values | tojson | safe }}'),

            peakLabels: JSON.parse('{{ analytics.peak_hours_labels | tojson | safe }}'),
            peakValues: JSON.parse('{{ analytics.peak_hours_values | tojson | safe }}'),

            effNames: JSON.parse('{{ analytics.ai_efficiency.names | tojson | safe }}'),
            effCounts: JSON.parse('{{ analytics.ai_efficiency.counts | tojson | safe }}'),

            popLabels: JSON.parse('{{ analytics.page_pop_labels | tojson | safe }}'),
            popValues: JSON.parse('{{ analytics.page_pop_values | tojson | safe }}')
        };

        // Charts Contexts
        var ctxAi = document.getElementById('aiChart');
        var ctxAllTime = document.getElementById('allTimeVisitorsChart');
        var ctxChat = document.getElementById('chatChart');
        var ctxLogin = document.getElementById('loginChart');
        var ctxServicesReq = document.getElementById('servicesReqChart');
        var ctxServicesView = document.getElementById('servicesViewChart');
        var ctxPeak = document.getElementById('peakHoursChart');
        var ctxEfficiency = document.getElementById('aiEfficiencyChart');
        var ctxPagePop = document.getElementById('pagePopChart');

        // Dynamic Colors
        function getColors(count) {
            var colors = ['#4caf50', '#2196f3', '#f44336', '#ffc107', '#9c27b0', '#00bcd4', '#e91e63'];
            var result = [];
            for (var i = 0; i < count; i++) result.push(colors[i % colors.length]);
            return result;
        }

        // Chart Options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            devicePixelRatio: 2,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#e0e0e0',
                        font: { family: 'Cairo', size: 11 },
                        padding: 10,
                        usePointStyle: true,
                        generateLabels: (chart) => {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const total = data.datasets[0].data.reduce((acc, val) => acc + val, 0);
                                return data.labels.map((label, i) => {
                                    const value = data.datasets[0].data[i];
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    return {
                                        text: `${label} (${percentage})`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: isNaN(data.datasets[0].data[i]) || chart.getDatasetMeta(0).data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function (context) {
                            let label = context.label || '';
                            let value = context.parsed;
                            let total = context.chart._metasets[context.datasetIndex].total;
                            let percentage = ((value / total) * 100).toFixed(1) + '%';
                            return `${label}: ${percentage} (${value})`;
                        }
                    }
                }
            }
        };

        // 1. Top AI Chat Users
        if (ctxAi) {
            new Chart(ctxAi, {
                type: 'doughnut',
                data: {
                    labels: chartData.topAiLabels,
                    datasets: [{
                        data: chartData.topAiValues,
                        backgroundColor: getColors(chartData.topAiValues.length),
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 2. All Time Visitors
        if (ctxAllTime) {
            new Chart(ctxAllTime, {
                type: 'doughnut',
                data: {
                    labels: chartData.allTimeLabels,
                    datasets: [{
                        data: chartData.allTimeValues,
                        backgroundColor: getColors(chartData.allTimeValues.length),
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 3. Heavy Visitors (Today)
        if (ctxChat) {
            new Chart(ctxChat, {
                type: 'doughnut',
                data: {
                    labels: chartData.chatLabels,
                    datasets: [{
                        data: chartData.chatValues,
                        backgroundColor: getColors(chartData.chatValues.length),
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 4. Daily Visitors (Today)
        if (ctxLogin) {
            new Chart(ctxLogin, {
                type: 'doughnut',
                data: {
                    labels: chartData.loginLabels,
                    datasets: [{
                        data: chartData.loginValues,
                        backgroundColor: getColors(chartData.loginValues.length),
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 5. Top Requested Services
        if (ctxServicesReq) {
            new Chart(ctxServicesReq, {
                type: 'doughnut',
                data: {
                    labels: chartData.reqLabels,
                    datasets: [{
                        data: chartData.reqValues,
                        backgroundColor: getColors(chartData.reqValues.length),
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 6. Top Viewed Services
        if (ctxServicesView) {
            new Chart(ctxServicesView, {
                type: 'doughnut',
                data: {
                    labels: chartData.viewLabels,
                    datasets: [{
                        data: chartData.viewValues,
                        backgroundColor: getColors(chartData.viewValues.length),
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 7. Peak Hours (Line)
        if (ctxPeak) {
            new Chart(ctxPeak, {
                type: 'line',
                data: {
                    labels: chartData.peakLabels,
                    datasets: [{
                        label: 'عدد الأنشطة',
                        data: chartData.peakValues,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, border: { display: false }, ticks: { color: '#e0e0e0' } },
                        x: { grid: { display: false }, ticks: { color: '#e0e0e0', font: { size: 10 } } }
                    }
                }
            });
        }

        // 8. AI Efficiency (Doughnut)
        if (ctxEfficiency) {
            new Chart(ctxEfficiency, {
                type: 'doughnut',
                data: {
                    labels: chartData.effNames,
                    datasets: [{
                        data: chartData.effCounts,
                        backgroundColor: ['#4caf50', '#f44336'],
                        borderWidth: 0
                    }]
                },
                options: commonOptions
            });
        }

        // 9. Page Popularity (Horizontal Bar)
        if (ctxPagePop) {
            new Chart(ctxPagePop, {
                type: 'bar',
                data: {
                    labels: chartData.popLabels,
                    datasets: [{
                        data: chartData.popValues,
                        backgroundColor: getColors(chartData.popValues.length),
                        borderRadius: 5
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#e0e0e0' } },
                        y: { grid: { display: false }, ticks: { color: '#fff', font: { family: 'Cairo' } } }
                    }
                }
            });
        }
    });
</script>
{% endblock %}