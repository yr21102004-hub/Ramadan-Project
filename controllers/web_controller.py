from flask import Blueprint, render_template, request, jsonify
from flask_login import current_user
from models import ContactModel, SecurityLogModel

contact_model = ContactModel()
security_log_model = SecurityLogModel()

web_bp = Blueprint('web', __name__)

SERVICES_DATA = {
    'modern-paints': {
        'title': 'دهانات حديثة',
        'description': 'نستخدم أحدث تقنيات الدهانات الديكورية والكمبيوتر لإضفاء لمسة جمالية فريدة على منزلك. لدينا مجموعة واسعة من الألوان والتأثيرات التي تناسب جميع الأذواق، سواء كنت تبحث عن طابع كلاسيكي أو مودرن.',
        'features': [
            'دهانات جوتن وسايبس عالية الجودة',
            'دهانات قطيفة وشمواه',
            'تنسيق ألوان احترافي'
        ],
        'image': 'modern_paints.png'
    },
    'gypsum-board': {
        'title': 'جبس بورد (تشطيب ودهانات)',
        'description': 'نقدم أرقى مستويات التشطيب لأعمال الجبس بورد والأسقف المعلقة. تخصصنا هو إظهار جمال التصميم من خلال مراحل المعجون والدهانات الدقيقة، لضمان سطح ناعم ومثالي يبرز روعة الإضاءة والتصميم. (نحن متخصصون في بند الدهانات والتشطيب وليس التركيب).',
        'features': [
            'معالجة فواصل الجبس بورد بمهارة عالية',
            'تشطيب ناعم (Full Finish) للأسقف ومكتبات الشاشات',
            'تنسيق ألوان الدهانات مع الإضاءة المخفية',
            'دهانات عالية الجودة تدوم طويلاً'
        ],
        'image': 'gypsum_finish.png'
    },
    'integrated-finishing': {
        'title': 'تشطيب متكامل',
        'description': 'خدمة تشطيب ودهانات متكاملة تضمن لك جودة عالية ولمسات فنية راقية. نهتم بأدق التفاصيل لضمان مظهر جمالي يتناسب مع ذوقك الرفيع، سواء للواجهات الخارجية أو الديكورات الداخلية.',
        'features': [
            'تشطيب دهانات بكافة انواعها داخلية و خارجية',
            'أعمال المحارة والجبس',
            'ديكورات وتجاليد حوائط'
        ],
        'image': 'integrated_finishing.png'
    },
    'putty-finishing': {
        'title': 'تشطيب كامل ومعجون',
        'description': 'تعتبر مرحلة المعجون هي الأساس لأي دهان ناجح. نحن نولي اهتماماً خاصاً لهذه المرحلة، حيث نقوم بتجهيز الحوائط بمهارة فائقة لضمان ملمس ناعم كالحرير وخالٍ من العيوب.',
        'features': [
            'سحب طبقات معجون متعددة لتسوية الحوائط',
            'صنفرة ميكانيكية ويدوية لإزالة الشوائب',
            'علاج عيوب المحارة والزوايا',
            'دهانات أساس (سيلر) عالية الجودة'
        ],
        'image': 'putty_finishing.png'
    },
    'wallpaper': {
        'title': 'تركيب ورق حائط',
        'description': 'أضف لمسة من الفخامة إلى غرفتك مع أحدث تشكيلات ورق الحائط. فنيونا محترفون في التركيب لضمان عدم وجود فواصل ظاهرة أو فقاعات هواء، مع الحفاظ على تناسق النقوش.',
        'features': [
            'تركيب جميع أنواع الورق (فينيل، قماش، 3D)',
            'تجهيز الحوائط قبل التركيب لضمان الثبات',
            'دقة متناهية في قص ولصق الأطراف',
            'تصميمات عصرية وكلاسيكية'
        ],
        'image': 'wallpaper.png'
    },
    'renovation': {
        'title': 'تجديد وترميم',
        'description': 'نعيد الحياة للمنازل والمباني القديمة. نقوم بمعالجة كافة مشاكل الرطوبة والشروخ، وتحديث شبكات المرافق، وتغيير الديكور بالكامل ليواكب أحدث الصيحات.',
        'features': [
            'علاج الشروخ وتصدعات الجدران',
            'حلول جذرية لمشاكل الرطوبة والنشع',
            'تحديث الأرضيات والدهانات',
            'إعادة توزيع الكهرباء والسباكة'
        ],
        'image': 'renovation.jpg'
    }
}

@web_bp.route('/')
def index():
    return render_template('home.html')

@web_bp.route('/service/<service_id>')
def service_detail(service_id):
    service = SERVICES_DATA.get(service_id)
    if not service:
        return render_template('404.html'), 404
        
    # Log this view for analytics
    security_log_model.create('Service View', f'User viewed service: {service["title"]}', severity="info")
    
    return render_template('service_detail.html', service=service)

@web_bp.route('/about')
def about():
    return render_template('about.html')

@web_bp.route('/services')
def services():
    return render_template('services.html')


PROJECTS_DATA = {
    'apartments': {
        'title': 'بنود دهانات الشقق السكنية',
        'sections': [
            {
                'title': 'تجهيز الأسطح',
                'details': [
                    'تنظيف الحوائط والأسقف من الأتربة والزيوت.',
                    'معالجة الشروخ والتعشيش.',
                    'سكينة معجون طبقتين لتحقيق الاستواء والنعومة المطلوبة.',
                    'دهان طبقة أساس مناسبة لنوع السطح.'
                ]
            },
            {
                'title': 'الدهانات النهائية',
                'details': [
                    'دهان نهائي عدد (2–3) طبقات من دهانات بلاستيك عالية الجودة للحوائط والأسقف.',
                    'دهان النجارة المعدنية والأبواب بطبقة أساس مضادة للصدأ ثم طبقتين دهان نهائي.',
                    'الالتزام بدرجات الألوان المعتمدة وتحقيق مستوى تشطيب اقتصادي إلى متوسط مطابق للمواصفات القياسية.'
                ]
            }
        ]
    },
    'villas': {
        'title': 'دهانات القصور والفلل الفاخرة',
        'description': 'نقدم خدمات دهانات داخلية متكاملة ومتميزة مخصصة للقصور والفلل الفاخرة، وفق أعلى المعايير الاحترافية في التصميم والتنفيذ. نعتمد على أجود الخامات العالمية وتقنيات التطبيق المتقدمة لضمان تشطيبات راقية، أسطح فائقة النعومة، وألوان متناسقة تعكس الفخامة والذوق الرفيع.',
        'images': ['palace.png', 'villa.png', 'hero.png'],
        'sections': [
            {
                'title': 'نطاق الخدمات',
                'details': [
                    'تنفيذ كافة التشطيبات الفاخرة للدهانات الداخلية',
                    'الدهانات الفينيسية (Venetian Plaster) بتقنيات احترافية',
                    'دهانات الاستوكو (Stucco) بلمسات فنية راقية',
                    'اللكر اللامع (High Gloss Lacquer) للأسطح الفاخرة',
                    'الدهانات المعدنية (Metallic Paints) بتأثيرات بصرية مميزة',
                    'الدهانات الحريرية القابلة للغسل (Washable Silk Paints)',
                    'عناية دقيقة بالتفاصيل الجمالية واستقامة الحواف',
                    'جودة عالية في اللمسات النهائية'
                ]
            },
            {
                'title': 'التحضير الاحترافي للأسطح',
                'details': [
                    'تحضير شامل للأسطح عبر مراحل دقيقة ومدروسة',
                    'المعجون المتعدد الطبقات لضمان استواء مثالي',
                    'الصنفرة الميكانيكية واليدوية لنعومة فائقة',
                    'البرايمر (Primer) عالي الجودة كطبقة أساس',
                    'تطبيق طبقات مدروسة تضمن المتانة والثبات',
                    'ضمان طول العمر الافتراضي للدهان',
                    'معالجة احترافية للشروخ والعيوب'
                ]
            },
            {
                'title': 'معايير الجودة والنظافة',
                'details': [
                    'أعلى مستويات النظافة المهنية أثناء التنفيذ',
                    'حماية كاملة للأرضيات والأثاث',
                    'استخدام مواد عزل وحماية احترافية',
                    'تنظيف يومي لموقع العمل',
                    'تسليم المشروع في أبهى صورة ممكنة',
                    'فحص دقيق لجودة التشطيب قبل التسليم'
                ]
            },
            {
                'title': 'رؤيتنا وهدفنا',
                'details': [
                    'هدفنا ليس مجرد دهان الجدران',
                    'خلق بيئة داخلية فاخرة تعكس هوية المكان',
                    'الارتقاء بالقيمة الجمالية للمساحات',
                    'تعزيز القيمة المعمارية للعقار',
                    'تحقيق رؤية العميل بأعلى معايير الاحترافية',
                    'ضمان رضا العميل التام عن النتيجة النهائية'
                ]
            }
        ]
    },
    'companies': {
        'title': 'بنود دهانات الشركات والمباني الإدارية',
        'description': 'نوفر حلولاً متكاملة لتشطيب الشركات والمكاتب تجمع بين الفخامة والعملية، مع مراعاة الهوية البصرية للمؤسسة وتوفير بيئة عمل ملهمة ومريحة.',
        'images': ['office_1.png', 'office_2.png', 'office_3.png'],
        'sections': [
            {
                'title': 'تجهيز الأسطح',
                'details': [
                    'تجهيز الأسطح بالطرق القياسية ومعالجة جميع العيوب السطحية.',
                    'تنفيذ سكينة معجون طبقتين لتحقيق سطح مستوٍ مناسب للأعمال الإدارية.',
                    'دهان طبقة أساس مناسبة.'
                ]
            },
            {
                'title': 'الدهانات العملية',
                'details': [
                    'دهان نهائي عدد (2–3) طبقات من دهانات عملية (سهلة التنظيف، مقاومة للاحتكاك).',
                    'استخدام ألوان رسمية هادئة متوافقة مع الهوية البصرية للمؤسسة.',
                    'دهان السلالم والممرات بدهانات مقاومة للاهتراء مع مراعاة اشتراطات السلامة ومقاومة الحريق عند الطلب.'
                ]
            }
        ]
    },
    'hotels': {
        'title': 'بنود دهانات الفنادق والمنتجعات',
        'description': 'نقدم حلول دهانات داخلية احترافية ومتخصصة للفنادق والمنتجعات، تجمع بين الفخامة، المتانة، وسهولة الصيانة بما يتناسب مع طبيعة الاستخدام المكثف للمساحات الفندقية. نعتمد على خامات عالمية عالية الجودة وتقنيات تطبيق متقدمة لضمان تشطيبات أنيقة، ألوان متناسقة، وأسقف وجدران ذات مظهر راقٍ يدعم هوية التصميم الداخلي للفندق.<br><br>تشمل خدماتنا تنفيذ تشطيبات فندقية متميزة مثل الدهانات الحريرية والمطّفية القابلة للغسل، الدهانات المضادة للبقع، الدهانات المقاومة للرطوبة، واللمسات الزخرفية الخاصة للمناطق المميزة كالمداخل الرئيسية واللوبي والمطاعم والأجنحة الفاخرة.<br><br>نلتزم بتحضير احترافي شامل للأسطح عبر مراحل دقيقة من المعجون والصنفرة والبرايمر، مع تطبيق طبقات مدروسة تضمن ثبات اللون، المتانة، وتحمل الاستخدام اليومي. كما نراعي معايير السلامة والنظافة المهنية أثناء التنفيذ، مع حماية كاملة للأثاث والمفروشات وتقليل الإزعاج أثناء التشغيل.<br><br>نسعى إلى تقديم بيئة داخلية مريحة بصريًا، أنيقة، وعملية، تعزز تجربة النزلاء وترفع من مستوى الانطباع العام للفندق.',
        'images': ['hotel_1.png', 'hotel_2.png', 'hotel_3.png', 'hotel_4.png'],
        'sections': [
            {
                'title': 'التجهيز الفندقي',
                'details': [
                    'تجهيز جميع الأسطح بدرجة عالية من الدقة لتحقيق تشطيب فندقي متجانس.',
                    'معالجة جميع الفواصل والشروخ بمواد مرنة لمنع التشققات المستقبلية.',
                    'تنفيذ سكينة معجون متعددة الطبقات مع الصنفرة الدقيقة.',
                    'دهان طبقات أساس متخصصة مقاومة للرطوبة والبكتيريا في المناطق الحساسة.'
                ]
            },
            {
                'title': 'الدهانات والمواصفات',
                'details': [
                    'دهان نهائي عدد (3–4) طبقات من دهانات عالية الجودة (مقاومة للبقع، سهولة التنظيف، ثبات لون عالي).',
                    'الالتزام باشتراطات السلامة ومقاومة الحريق طبقاً لكود الفنادق.',
                    'تنفيذ دهانات ديكورية خاصة في اللوبيات والأجنحة حسب التصميم المعماري.'
                ]
            }
        ]
    },
    'factories': {
        'title': 'بنود دهانات المصانع والمنشآت الصناعية',
        'sections': [
            {
                'title': 'تجهيز الأسطح الصناعية',
                'details': [
                    'تنظيف ميكانيكي أو رملي للأسطح المعدنية والخرسانية.',
                    'إزالة الصدأ والزيوت والملوثات الصناعية.',
                    'دهان طبقة برايمر صناعي متخصص حسب نوع السطح.'
                ]
            },
            {
                'title': 'الدهانات الصناعية والأرضيات',
                'details': [
                    'تنفيذ دهانات نهائية صناعية (إيبوكسي، بولي يوريثان) لمقاومة الكيماويات والزيوت والرطوبة والحرارة.',
                    'تنفيذ دهانات أرضيات صناعية إيبوكسي حسب مناطق التشغيل.',
                    'دهان إرشادي لتحديد مسارات الحركة ومناطق الخطر ومناطق التخزين.',
                    'الالتزام الكامل باشتراطات السلامة الصناعية والكود الفني المعتمد.'
                ]
            }
        ]
    }
}

@web_bp.route('/projects')
def projects():
    return render_template('projects.html')

@web_bp.route('/project/<category>')
def project_detail(category):
    project = PROJECTS_DATA.get(category)
    if not project:
        return render_template('404.html'), 404
        
    security_log_model.create('Project View', f'User viewed project category: {project["title"]}', severity="info")
    return render_template('project_detail.html', project=project)

@web_bp.route('/contact')
def contact():
    return render_template('contact.html')

@web_bp.route('/api/contact', methods=['POST'])
def contact_api():
    try:
        data = request.json
        name = data.get('name')
        phone = data.get('phone')
        message = data.get('message')
        service = data.get('service', 'عام')
        
        if not name or not phone or not message:
            return jsonify({'error': 'Missing required fields'}), 400
        
        user_id = current_user.username if current_user.is_authenticated else None
        
        contact_model.create(name, phone, message, user_id, service)
        return jsonify({'message': 'Success'}), 200
    except Exception as e:
        print(f"Error saving contact: {e}")
        return jsonify({'error': 'Internal Server Error'}), 500
